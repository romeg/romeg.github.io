<?xml version="1.0" encoding="utf-8" standalone="yes" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>Posts on Oh, my blog!</title>
    <link>http://maks.me/post/</link>
    <description>Recent content in Posts on Oh, my blog!</description>
    <generator>Hugo -- gohugo.io</generator>
    <language>en-us</language>
    <copyright>This work is licensed under a Creative Commons Attribution-ShareAlike 4.0 International License.</copyright>
    <lastBuildDate>Mon, 22 Aug 2016 12:59:02 +0400</lastBuildDate>
    <atom:link href="http://maks.me/post/index.xml" rel="self" type="application/rss+xml" />
    
    <item>
      <title>GitLab CI runner and VirtualBox </title>
      <link>http://maks.me/post/gitlab-runner-and-virtualbox/</link>
      <pubDate>Mon, 22 Aug 2016 12:59:02 +0400</pubDate>
      
      <guid>http://maks.me/post/gitlab-runner-and-virtualbox/</guid>
      <description>

&lt;p&gt;Recently, I have been installing such configuration and discover that not a lot documentation exist in Internet. So, I write this post as summary. I think that this is also can be usefull for guys who want install GitLab runner and Virtualbox on headless server using Puppet and automate this provision as much as possible. There are some caveats that requires manual work but it is also can be easily automated.&lt;/p&gt;

&lt;h2 id=&#34;puppet&#34;&gt;Puppet&lt;/h2&gt;

&lt;h3 id=&#34;modules&#34;&gt;Modules&lt;/h3&gt;

&lt;p&gt;I used modules from Puppetforge so you can install it using usual process&lt;/p&gt;
&lt;div class=&#34;highlight&#34; style=&#34;background: #f8f8f8&#34;&gt;&lt;pre style=&#34;line-height: 125%&#34;&gt;&lt;span&gt;&lt;/span&gt;puppet module install vshn-gitlab
puppet module install danzilio-virtualbox
&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;If you are using &lt;kbd&gt;r10k&lt;/kbd&gt; for management Puppet modules and code you need to add following modules to your &lt;code&gt;Puppetfile&lt;/code&gt;:&lt;/p&gt;
&lt;div class=&#34;highlight&#34; style=&#34;background: #f8f8f8&#34;&gt;&lt;pre style=&#34;line-height: 125%&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;span style=&#34;color: #7D9029&#34;&gt;mod&lt;/span&gt; &lt;span style=&#34;color: #BA2121&#34;&gt;&amp;#39;vshn/gitlab&amp;#39;&lt;/span&gt;, &lt;span style=&#34;color: #BA2121&#34;&gt;&amp;#39;1.8.0&amp;#39;&lt;/span&gt;
&lt;span style=&#34;color: #7D9029&#34;&gt;mod&lt;/span&gt; &lt;span style=&#34;color: #BA2121&#34;&gt;&amp;#39;danzilio/virtualbox&amp;#39;&lt;/span&gt;, &lt;span style=&#34;color: #BA2121&#34;&gt;&amp;#39;1.7.1&amp;#39;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;Do not forget check dependencies:&lt;/p&gt;
&lt;div class=&#34;highlight&#34; style=&#34;background: #f8f8f8&#34;&gt;&lt;pre style=&#34;line-height: 125%&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;span style=&#34;color: #7D9029&#34;&gt;mod&lt;/span&gt; &lt;span style=&#34;color: #BA2121&#34;&gt;&amp;#39;puppetlabs/stdlib&amp;#39;&lt;/span&gt;, &lt;span style=&#34;color: #BA2121&#34;&gt;&amp;#39;4.12.0&amp;#39;&lt;/span&gt;
&lt;span style=&#34;color: #7D9029&#34;&gt;mod&lt;/span&gt; &lt;span style=&#34;color: #BA2121&#34;&gt;&amp;#39;puppet/archive&amp;#39;&lt;/span&gt;, &lt;span style=&#34;color: #BA2121&#34;&gt;&amp;#39;1.0.0&amp;#39;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;

&lt;h3 id=&#34;configuration&#34;&gt;Configuration&lt;/h3&gt;

&lt;p&gt;Node definition in my case was like this:&lt;/p&gt;
&lt;div class=&#34;highlight&#34; style=&#34;background: #f8f8f8&#34;&gt;&lt;pre style=&#34;line-height: 125%&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;span style=&#34;color: #008000; font-weight: bold&#34;&gt;node&lt;/span&gt; &lt;span style=&#34;color: #BA2121&#34;&gt;&amp;#39;gitlab-runner&amp;#39;&lt;/span&gt; {
	&lt;span style=&#34;color: #008000; font-weight: bold&#34;&gt;include&lt;/span&gt; &lt;span style=&#34;color: #7D9029&#34;&gt;virtualbox&lt;/span&gt;
	&lt;span style=&#34;color: #7D9029&#34;&gt;virtualbox&lt;/span&gt;::&lt;span style=&#34;color: #7D9029&#34;&gt;extpack&lt;/span&gt; { &lt;span style=&#34;color: #BA2121&#34;&gt;&amp;#39;Oracle_VM_VirtualBox_Extension_Pack&amp;#39;&lt;/span&gt;:
	  &lt;span style=&#34;color: #7D9029&#34;&gt;ensure&lt;/span&gt;           &lt;span style=&#34;color: #666666&#34;&gt;=&amp;gt;&lt;/span&gt; &lt;span style=&#34;color: #008000; font-weight: bold&#34;&gt;present&lt;/span&gt;,
	  &lt;span style=&#34;color: #7D9029&#34;&gt;source&lt;/span&gt;           &lt;span style=&#34;color: #666666&#34;&gt;=&amp;gt;&lt;/span&gt; &lt;span style=&#34;color: #BA2121&#34;&gt;&amp;#39;http://download.virtualbox.org/virtualbox/5.1.2/Oracle_VM_VirtualBox_Extension_Pack-5.1.2-108956.vbox-extpack&amp;#39;&lt;/span&gt;,
	  &lt;span style=&#34;color: #7D9029&#34;&gt;checksum_string&lt;/span&gt;  &lt;span style=&#34;color: #666666&#34;&gt;=&amp;gt;&lt;/span&gt; &lt;span style=&#34;color: #BA2121&#34;&gt;&amp;#39;7614ce90e17297f80d6a5822252c90d9&amp;#39;&lt;/span&gt;,
	  &lt;span style=&#34;color: #7D9029&#34;&gt;follow_redirects&lt;/span&gt; &lt;span style=&#34;color: #666666&#34;&gt;=&amp;gt;&lt;/span&gt; &lt;span style=&#34;color: #008000; font-weight: bold&#34;&gt;true&lt;/span&gt;,
	}

	&lt;span style=&#34;color: #008000; font-weight: bold&#34;&gt;class&lt;/span&gt; { &lt;span style=&#34;color: #BA2121&#34;&gt;&amp;#39;::gitlab::cirunner&amp;#39;&lt;/span&gt;:
	    &lt;span style=&#34;color: #7D9029&#34;&gt;manage_docker&lt;/span&gt; &lt;span style=&#34;color: #666666&#34;&gt;=&amp;gt;&lt;/span&gt; &lt;span style=&#34;color: #008000; font-weight: bold&#34;&gt;false&lt;/span&gt;,
	}

	&lt;span style=&#34;color: #19177C&#34;&gt;$runners_hash&lt;/span&gt; &lt;span style=&#34;color: #666666&#34;&gt;=&lt;/span&gt; {
	    &lt;span style=&#34;color: #BA2121&#34;&gt;&amp;#39;runner_for_virtualbox&amp;#39;&lt;/span&gt; &lt;span style=&#34;color: #666666&#34;&gt;=&amp;gt;&lt;/span&gt; {}
	}

	&lt;span style=&#34;color: #19177C&#34;&gt;$default_config&lt;/span&gt; &lt;span style=&#34;color: #666666&#34;&gt;=&lt;/span&gt; {
	&lt;span style=&#34;color: #BA2121&#34;&gt;&amp;#39;url&amp;#39;&lt;/span&gt; &lt;span style=&#34;color: #666666&#34;&gt;=&amp;gt;&lt;/span&gt; &lt;span style=&#34;color: #BA2121&#34;&gt;&amp;quot;https://gitlab.example.com/&amp;quot;&lt;/span&gt;,
	&lt;span style=&#34;color: #BA2121&#34;&gt;&amp;#39;registration-token&amp;#39;&lt;/span&gt; &lt;span style=&#34;color: #666666&#34;&gt;=&amp;gt;&lt;/span&gt; &lt;span style=&#34;color: #BA2121&#34;&gt;&amp;quot;your_agent_registration_token&amp;quot;&lt;/span&gt;,
	&lt;span style=&#34;color: #BA2121&#34;&gt;&amp;#39;executor&amp;#39;&lt;/span&gt; &lt;span style=&#34;color: #666666&#34;&gt;=&amp;gt;&lt;/span&gt; &lt;span style=&#34;color: #BA2121&#34;&gt;&amp;quot;virtualbox&amp;quot;&lt;/span&gt;
	}

	&lt;span style=&#34;color: #7D9029&#34;&gt;gitlab&lt;/span&gt;::&lt;span style=&#34;color: #7D9029&#34;&gt;runner&lt;/span&gt; { &lt;span style=&#34;color: #BA2121&#34;&gt;&amp;#39;runner_for_virtualbox&amp;#39;&lt;/span&gt;:
	    &lt;span style=&#34;color: #7D9029&#34;&gt;default_config&lt;/span&gt; &lt;span style=&#34;color: #666666&#34;&gt;=&amp;gt;&lt;/span&gt; &lt;span style=&#34;color: #19177C&#34;&gt;$default_config,&lt;/span&gt;
	    &lt;span style=&#34;color: #7D9029&#34;&gt;runners_hash&lt;/span&gt;   &lt;span style=&#34;color: #666666&#34;&gt;=&amp;gt;&lt;/span&gt; &lt;span style=&#34;color: #19177C&#34;&gt;$runners_hash,&lt;/span&gt;
	    &lt;span style=&#34;color: #7D9029&#34;&gt;require&lt;/span&gt; &lt;span style=&#34;color: #666666&#34;&gt;=&amp;gt;&lt;/span&gt; [&lt;span style=&#34;color: #008000; font-weight: bold&#34;&gt;Class&lt;/span&gt;[&lt;span style=&#34;color: #BA2121&#34;&gt;&amp;#39;Virtualbox&amp;#39;&lt;/span&gt;],&lt;span style=&#34;color: #7D9029&#34;&gt;Virtualbox&lt;/span&gt;::&lt;span style=&#34;color: #7D9029&#34;&gt;Extpack&lt;/span&gt;[&lt;span style=&#34;color: #BA2121&#34;&gt;&amp;#39;Oracle_VM_VirtualBox_Extension_Pack&amp;#39;&lt;/span&gt;]]
	}
}
&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;Notes:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;code&gt;manage_docker&lt;/code&gt; should be false, otherwise you need to add docker module and other hustling around docker installation&lt;/li&gt;
&lt;li&gt;&lt;kbd&gt;hiera&lt;/kbd&gt; wasn&amp;rsquo;t used in this example but all modules support it&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&#34;virualbox&#34;&gt;VirualBox&lt;/h2&gt;

&lt;h3 id=&#34;extension-pack&#34;&gt;Extension Pack&lt;/h3&gt;

&lt;p&gt;Most critical remainder, VirtualBox must have Oracle VM VirtualBox extension pack installed otherwise gitlab build&amp;rsquo;s will fail in a strange ways. Such as timeouts, errors and so on.&lt;/p&gt;

&lt;p&gt;Other notes:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;node what you are trying to use as virtualbox base must have Vt-x enabled (or nested virtualization)&lt;/li&gt;
&lt;li&gt;ensure that nothing blocks VirtualBox networks&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&#34;base-image&#34;&gt;Base image&lt;/h3&gt;

&lt;ul&gt;
&lt;li&gt;&lt;kbd&gt;vagrant&lt;/kbd&gt; unfortunately doesn&amp;rsquo;t supported by gitlab runner :( See: links.
As gitlab runner doesn&amp;rsquo;t support vagrant and other types of provisioning VMs you need to&lt;br /&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;To be finished 8(&lt;/p&gt;
</description>
    </item>
    
  </channel>
</rss>